#!/bin/bash

#Set the options of the getopt command
format=$(getopt -n "$0" -l "image-name:,sha:,source-dir:" -- -- "$@")
if [ $# -lt 3 ]; then
   echo "Wrong number of arguments are passed."
   exit
fi
eval set -- "$format"

#Read the argument values
while [ $# -gt 0 ]
do
     case "$1" in
          --image-name) IMAGE_NAME="$2"; shift;;
          --sha) SHA="$2"; shift;;
          --source) SOURCE_DIR="$2"; shift;;
          --) shift;;
     esac
     shift;
done

docker build \
  --build-arg AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN \
  --build-arg AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
  --build-arg AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
  --build-arg GITHUB_TOKEN=$GITHUB_TOKEN \
  --build-arg USE_CUDA=$USE_CUDA \
  --progress=plain \
  --tag=$IMAGE_NAME:$SHA \
  --label "git-commit=$SHA" \
  -f continuous_integration/Dockerfile $SOURCE_DIR
